---
title: "Aligning plots"
author: "Claus O. Wilke"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_width: 4
vignette: >
  %\VignetteIndexEntry{Aligning plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

There are several packages that can be used to align plots. The most widely used ones beside cowplot are egg and patchwork. All these packages use slightly different approaches to plot alignment, and the respective approaches have different strengths and weaknesses. If you cannot achieve your desired result with one of these packages try another one.

Most importantly, while egg and patchwork align and arrange plots at the same time, cowplot aligns plots independently of how they are arranged. This makes it possible to align plots and then reproduce them separately, or even overlay them on top of each other.

We'll start with a very simple example. Let's consider these two plots.

```{r message = FALSE}
library(ggplot2)
library(cowplot)

p1 <- ggplot(mtcars, aes(disp, mpg)) + 
  geom_point()
p2 <- ggplot(mtcars, aes(disp, hp)) + 
  geom_point()
p1
p2
```

Both plots have the same x axis, but the width of the plot area is slightly larger in the first than in the second, because the y axis ticks have different lengths. These differences in plot width could be distracting in a document where both plots are shown near each other. We can fix this problem by vertically aligning the two plots and then drawing them individually.

```{r}
aligned <- align_plots(p1, p2, align = "v")
ggdraw(aligned[[1]])
ggdraw(aligned[[2]])
```

Vertical alignment (`align = "v"`) means that any vertical reference lines, such as the right and left y axis lines, are aligned in the plots. By contrast, horizontal alignment (`align = "h"`) aligns horizontal reference lines.

As a second example, we'll make two separate plots and then draw them on top of each other. First, we draw a bar plot of the number of cars in different classes in the `mpg` dataset.

```{r message = FALSE, fig.width = 5.5}
library(dplyr)
library(forcats)

city_mpg <- mpg %>%
  mutate(class = fct_lump(class, 4, other_level = "other")) %>%
  group_by(class) %>%
  summarize(
    `city mpg` = mean(cty),
    count = n()
  ) %>% 
  mutate(class = fct_reorder(class, -`city mpg`))

p1 <- ggplot(city_mpg, aes(class, count)) +
  geom_col(fill = "#6297E770") + 
  scale_y_continuous(
    expand = expand_scale(mult = c(0, 0.05)),
    position = "right"
  ) +
  theme_minimal_hgrid(11, rel_small = 1) +
  theme(
    panel.grid.major = element_line(color = "#6297E770"),
    axis.line.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks = element_blank(),
    axis.ticks.length = grid::unit(0, "pt"),
    axis.text.y = element_text(color = "#6297E7"),
    axis.title.y = element_text(color = "#6297E7")
  )
p1
```

Now we plot mean city mpg versus car class, as a scatter plot.

```{r message = FALSE, fig.width = 5.5}
p2 <- ggplot(city_mpg, aes(class, `city mpg`)) + 
  geom_point(size = 3, color = "#D5442D") + 
  scale_y_continuous(limits = c(10, 21)) +
  theme_half_open(11, rel_small = 1) +
  theme(
    axis.ticks.y = element_line(color = "#BB2D05"),
    axis.text.y = element_text(color = "#BB2D05"),
    axis.title.y = element_text(color = "#BB2D05"),
    axis.line.y = element_line(color = "#BB2D05")
  )
p2
```

Now we align the two plots and then overlay them. The resulting plot has dual axes, and making such plots is usually discouraged. I present this example here only to show the types of effects we can achieve when plot alignment and plot placement are separated.

```{r message = FALSE, fig.width = 5.5}
aligned_plots <- align_plots(p1, p2, align="hv", axis="tblr")
ggdraw(aligned_plots[[1]]) + draw_plot(aligned_plots[[2]])
```


## Aligning by axis

*Some intro text here.*

```{r fig.width = 7}
p1 <- ggplot(mtcars, aes(disp, mpg)) + 
  geom_point() +
  theme_minimal_grid(14) + 
  panel_border(color = "black")

p2 <- ggplot(mtcars, aes(factor(vs))) + 
  geom_bar() + 
  facet_wrap(~am) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  theme_minimal_hgrid(12) +
  panel_border(color = "black") +
  theme(strip.background = element_rect(fill = "gray80"))
```

Because we have used to themes with different base sizes (14 points and 12 points), the two plots are not aligned. If we try to align them horizontally, we receive a warning that the plots cannot be aligned.

```{r fig.width = 7}
plot_grid(p1, p2, align = "h", rel_widths = c(1, 1.3))
```

This warning indicates that cowplot doesn't know how these plots should be aligned. There are two alternatives, and both can be meaningful. First, we can align only the bottom axis (`axis = "b"`).

```{r fig.width = 7}
plot_grid(p1, p2, align = "h", axis = "b", rel_widths = c(1, 1.3))
```

Second, we can align both the bottom and the top axis (`axis = "bt"`).

```{r fig.width = 7}
plot_grid(p1, p2, align = "h", axis = "bt", rel_widths = c(1, 1.3))
```
